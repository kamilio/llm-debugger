<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Debugger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            --bg: #f7f8fa;
            --bg-strong: #eef1f4;
            --panel: #ffffff;
            --panel-alt: #f6f8fa;
            --ink: #1d1f23;
            --muted: #5d6670;
            --accent: #10a37f;
            --accent-strong: #0f8a6b;
            --stroke: #e2e6ea;
            --success: #1a7f4a;
            --danger: #b3261e;
            --code-bg: #f3f5f7;
            --code-ink: #1f2933;
            --code-border: #e1e5ea;
            --shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 10px 26px rgba(15, 23, 42, 0.08);
            --focus: rgba(16, 163, 127, 0.22);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "IBM Plex Sans", "Helvetica Neue", sans-serif;
            background:
                radial-gradient(1200px 520px at 12% -10%, rgba(16, 163, 127, 0.12), transparent 60%),
                radial-gradient(1000px 500px at 95% -20%, rgba(15, 23, 42, 0.08), transparent 60%),
                linear-gradient(180deg, var(--bg) 0%, #f1f3f6 100%);
            color: var(--ink);
        }

        .page {
            min-height: 100vh;
            padding: 32px 18px 64px;
        }

        .shell {
            max-width: 1240px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
        }

        .back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-strong);
            text-decoration: none;
            font-weight: 600;
        }

        .back::before {
            content: "\2190";
        }

        .hero {
            display: grid;
            gap: 12px;
            padding: 26px;
            border-radius: 24px;
            border: 1px solid var(--stroke);
            background: var(--panel);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            animation: none;
        }

        .hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(16, 163, 127, 0.12), transparent 60%);
            pointer-events: none;
        }

        .hero-top {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .title {
            font-family: "Sora", "Helvetica Neue", sans-serif;
            font-size: clamp(1.6rem, 2vw + 1rem, 2.4rem);
            margin: 0 0 6px;
        }

        .subtitle {
            margin: 0;
            color: var(--muted);
        }

        .pill-group {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            background: var(--bg-strong);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .pill.get { background: rgba(26, 127, 74, 0.12); color: #13633b; }
        .pill.post { background: rgba(22, 98, 166, 0.12); color: #1c4a7d; }
        .pill.put { background: rgba(200, 120, 28, 0.12); color: #7a4d16; }
        .pill.delete { background: rgba(179, 38, 30, 0.12); color: #7e1f18; }
        .pill.patch { background: rgba(96, 74, 155, 0.12); color: #4a3a8a; }

        .pill.status.ok {
            color: var(--success);
            border: 1px solid rgba(47, 138, 74, 0.3);
            background: rgba(47, 138, 74, 0.08);
        }

        .pill.status.bad {
            color: var(--danger);
            border: 1px solid rgba(178, 58, 58, 0.3);
            background: rgba(178, 58, 58, 0.08);
        }

        .btn {
            border: none;
            border-radius: 14px;
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease;
            box-shadow: 0 10px 24px rgba(16, 163, 127, 0.28);
            min-height: 40px;
        }

        .btn.secondary {
            background: #fff;
            color: var(--ink);
            border: 1px solid var(--stroke);
            box-shadow: none;
        }

        .timeline {
            padding: 18px 20px;
            border-radius: 20px;
            border: 1px solid var(--stroke);
            background: var(--panel);
            box-shadow: var(--shadow-soft);
            display: grid;
            gap: 12px;
        }

        .timeline-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
        }

        .timeline-row {
            display: grid;
            grid-template-columns: minmax(180px, 240px) 1fr;
            gap: 12px;
            align-items: center;
            font-variant-numeric: tabular-nums;
        }

        .timeline-label {
            display: grid;
            gap: 4px;
        }

        .timeline-label strong {
            font-size: 0.85rem;
        }

        .timeline-meta {
            font-size: 0.72rem;
            color: var(--muted);
        }

        .timeline-track {
            position: relative;
            height: 16px;
            border-radius: 999px;
            background: var(--bg-strong);
            overflow: hidden;
        }

        .timeline-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--duration, 0%);
            background: linear-gradient(90deg, rgba(16, 163, 127, 0.55), rgba(16, 163, 127, 0.9));
        }

        .timeline-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.72rem;
            color: rgba(29, 31, 35, 0.7);
        }

        .baseline-group {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .baseline-label {
            background: rgba(16, 163, 127, 0.12);
            color: var(--accent-strong);
        }

        .baseline-select {
            border: 1px solid var(--stroke);
            border-radius: 999px;
            padding: 6px 28px 6px 12px;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            background-color: #fff;
            color: var(--ink);
            appearance: none;
            background-image:
                linear-gradient(45deg, transparent 50%, rgba(93, 102, 112, 0.8) 50%),
                linear-gradient(135deg, rgba(93, 102, 112, 0.8) 50%, transparent 50%);
            background-position: right 14px center, right 9px center;
            background-size: 6px 6px;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        .baseline-select:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }

        .summary-card.is-baseline {
            border-color: rgba(16, 163, 127, 0.45);
            box-shadow: 0 16px 30px rgba(16, 163, 127, 0.12);
        }

        .baseline-chip {
            background: rgba(16, 163, 127, 0.16);
            color: var(--accent-strong);
        }

        .compare-scroll {
            overflow-x: auto;
            padding-bottom: 12px;
        }

        .compare-grid {
            display: grid;
            grid-template-columns: repeat(var(--columns, 2), minmax(260px, 1fr));
            gap: 16px;
            align-items: start;
        }

        .summary-card,
        .compare-section,
        .empty {
            padding: 18px 20px;
            border-radius: 20px;
            border: 1px solid var(--stroke);
            background: var(--panel);
            display: grid;
            gap: 12px;
            align-content: start;
        }

        .summary-card {
            position: relative;
            overflow: hidden;
        }

        .summary-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(16, 163, 127, 0.08), transparent 60%);
            opacity: 0.6;
            pointer-events: none;
        }

        .summary-header {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .summary-url {
            font-family: "IBM Plex Mono", monospace;
            font-size: 0.85rem;
            font-weight: 600;
            word-break: break-all;
            position: relative;
            z-index: 1;
        }

        .summary-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--muted);
            position: relative;
            z-index: 1;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 0.95rem;
        }

        .section-toggle {
            border: 1px solid var(--stroke);
            background: #fff;
            color: var(--accent-strong);
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
            padding: 4px 10px;
            cursor: pointer;
        }

        .section-toggle:hover {
            box-shadow: 0 8px 18px rgba(16, 163, 127, 0.18);
            transform: translateY(-1px);
        }

        pre {
            margin: 0;
            background: var(--code-bg);
            color: var(--code-ink);
            padding: 14px;
            border-radius: 16px;
            border: 1px solid var(--code-border);
            overflow-x: auto;
            font-size: 0.8rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: "IBM Plex Mono", monospace;
            align-self: start;
        }

        .diff-added {
            background: rgba(26, 127, 74, 0.2);
            color: #13633b;
        }

        .diff-removed {
            background: rgba(179, 38, 30, 0.16);
            color: #7e1f18;
            text-decoration: line-through;
        }

        .diff-neutral {
            color: var(--code-ink);
        }

        .diff-empty {
            color: var(--muted);
            font-style: italic;
        }

        .compare-section.is-collapsed pre {
            display: none;
        }

        .collapsed-note {
            display: none;
            font-size: 0.8rem;
            color: var(--muted);
            padding: 6px 0 2px;
        }

        .compare-section.is-collapsed .collapsed-note {
            display: block;
        }

        .empty {
            text-align: center;
            color: var(--muted);
        }

        .muted {
            color: var(--muted);
        }

        .btn:focus-visible,
        .back:focus-visible,
        .section-toggle:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }

        @media (max-width: 720px) {
            .hero {
                padding: 20px;
            }

            .summary-card,
            .compare-section {
                padding: 16px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <% function formatSection(value) { %>
        <% try { %>
            <% if (value === undefined || value === null) return ''; %>
            <% if (typeof value === 'string') return value; %>
            <% return JSON.stringify(value, null, 2); %>
        <% } catch (error) { %>
            <% return String(value); %>
        <% } %>
    <% } %>
    <% const sections = (compareSections && compareSections.length)
        ? compareSections.map((section) => ({
            key: section.key,
            title: section.label || section.title,
        }))
        : [
            { key: 'requestHeaders', title: 'Request headers' },
            { key: 'responseHeaders', title: 'Response headers' },
            { key: 'requestBody', title: 'Request body' },
            { key: 'responseBody', title: 'Response body' },
        ]; %>
    <% const baseline = Number.isFinite(baselineIndex)
        ? baselineIndex
        : (compareData && Number.isFinite(compareData.baselineIndex) ? compareData.baselineIndex : 0); %>
    <div class="page">
        <div class="shell">
            <a class="back" href="<%= backLink %>">Back to viewer</a>

            <section class="hero">
                <div class="hero-top">
                    <div>
                        <h1 class="title">Compare logs</h1>
                        <p class="subtitle">Inspect up to three requests side-by-side.</p>
                    </div>
                    <button class="btn secondary" id="copy-markdown" type="button">Copy Markdown</button>
                </div>
                <% if (logs && logs.length) { %>
                    <div class="pill-group baseline-group">
                        <span class="pill"><%= logs.length %> selected</span>
                        <span class="pill baseline-label">Baseline</span>
                        <select id="baseline-select" class="baseline-select" aria-label="Baseline log">
                            <% logs.forEach((log, index) => { %>
                                <option value="<%= index + 1 %>" <%= index === baseline ? 'selected' : '' %>>
                                    Log <%= index + 1 %> 路 <%= log.request.method %> <%= log.response.status %>
                                </option>
                            <% }) %>
                        </select>
                    </div>
                <% } %>
            </section>

            <% if (error) { %>
                <section class="empty"><%= error %></section>
            <% } else { %>
                <% if (logs && logs.length) { %>
                    <section class="timeline" aria-label="Request duration comparison">
                        <div class="timeline-title">Request duration comparison</div>
                        <% logs.forEach((log, index) => { %>
                            <div class="timeline-row"
                                data-duration="<%= log.duration_ms || 0 %>">
                                <div class="timeline-label">
                                    <strong>Log <%= index + 1 %> 路 <%= log.request.method %> 路 <%= log.response.status %></strong>
                                    <span class="timeline-meta"><%= log.provider || 'unknown' %> 路 <%= new Date(log.timestamp).toLocaleTimeString() %></span>
                                </div>
                                <div class="timeline-track">
                                    <span class="timeline-bar"></span>
                                    <span class="timeline-value"><%= log.duration_ms || 0 %>ms</span>
                                </div>
                            </div>
                        <% }) %>
                    </section>
                <% } %>
                <section class="compare-scroll">
                    <div class="compare-grid" style="--columns: <%= logs.length %>;">
                        <% logs.forEach((log, index) => { %>
                            <% const providerName = log.provider || 'unknown'; %>
                            <% const isBaseline = index === baseline; %>
                            <article class="summary-card <%= isBaseline ? 'is-baseline' : '' %>">
                                <div class="summary-header">
                                    <span class="pill">Log <%= index + 1 %></span>
                                    <span class="pill <%= (log.request.method || '').toLowerCase() %>"><%= log.request.method %></span>
                                    <span class="pill status <%= log.response.status < 400 ? 'ok' : 'bad' %>"><%= log.response.status %></span>
                                    <% if (isBaseline) { %>
                                        <span class="pill baseline-chip">Baseline</span>
                                    <% } %>
                                </div>
                                <div class="summary-url"><%= log.request.url %></div>
                                <div class="summary-meta">
                                    <span><%= providerName %></span>
                                    <span><%= new Date(log.timestamp).toLocaleString() %></span>
                                    <span><%= log.duration_ms || 0 %>ms</span>
                                </div>
                            </article>
                        <% }) %>

                        <% sections.forEach((section) => { %>
                            <% logs.forEach((log, index) => { %>
                                <section class="compare-section" data-section="<%= section.key %>" data-log-index="<%= index %>">
                                    <div class="section-header">
                                        <h3><%= section.title %></h3>
                                        <button class="section-toggle" type="button" data-section="<%= section.key %>">Collapse</button>
                                    </div>
                                    <div class="collapsed-note">Identical across logs. Click to expand.</div>
                                    <pre data-section="<%= section.key %>" data-log-index="<%= index %>"><%= formatSection(
                                        section.key === 'requestHeaders' ? log?.request?.headers :
                                        section.key === 'responseHeaders' ? log?.response?.headers :
                                        section.key === 'requestBody' ? log?.request?.body :
                                        log?.response?.body
                                    ) %></pre>
                                </section>
                            <% }) %>
                        <% }) %>
                    </div>
                </section>
            <% } %>
        </div>
    </div>

    <script>
        window.COMPARE_LOGS = <%- JSON.stringify(logs || []).replace(/</g, '\\u003c') %>;
        window.COMPARE_DATA = <%- JSON.stringify(compareData || {}).replace(/</g, '\\u003c') %>;

        const logs = Array.isArray(window.COMPARE_LOGS) ? window.COMPARE_LOGS : [];
        const compareData = window.COMPARE_DATA || {};
        const compareSections = Array.isArray(compareData.sections) ? compareData.sections : [];
        const baselineIndex = Number.isFinite(compareData.baselineIndex) ? compareData.baselineIndex : 0;
        const collapsedSections = new Map();
        const sectionValues = new Map();
        const diffCache = new Map();

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function diffToHtml(parts) {
            return parts
                .map((part) => {
                    const className = part.added
                        ? 'diff-added'
                        : part.removed
                            ? 'diff-removed'
                            : 'diff-neutral';
                    return `<span class="${className}">${escapeHtml(part.value)}</span>`;
                })
                .join('');
        }

        function diffToMarkdown(parts) {
            return parts
                .map((part) => {
                    const prefix = part.added ? '+' : part.removed ? '-' : ' ';
                    return part.value
                        .split('\n')
                        .map((line, index, lines) => {
                            if (index === lines.length - 1 && line === '') return null;
                            return `${prefix}${line}`;
                        })
                        .filter(Boolean)
                        .join('\n');
                })
                .filter(Boolean)
                .join('\n');
        }

        function setSectionCollapsed(sectionKey, collapsed) {
            collapsedSections.set(sectionKey, collapsed);
            document.querySelectorAll(`.compare-section[data-section="${sectionKey}"]`).forEach((section) => {
                section.classList.toggle('is-collapsed', collapsed);
            });
            document.querySelectorAll(`.section-toggle[data-section="${sectionKey}"]`).forEach((button) => {
                button.textContent = collapsed ? 'Expand' : 'Collapse';
                button.setAttribute('aria-expanded', String(!collapsed));
            });
        }

        function renderDiffs() {
            if (!compareSections.length || !logs.length) return;

            compareSections.forEach((section) => {
                const values = Array.isArray(section.values) ? section.values : [];
                const diffs = Array.isArray(section.diffs) ? section.diffs : [];
                sectionValues.set(section.key, values);
                diffCache.set(section.key, diffs);

                values.forEach((value, index) => {
                    const target = document.querySelector(
                        `pre[data-section="${section.key}"][data-log-index="${index}"]`
                    );
                    if (!target) return;
                    const diffParts = diffs[index] || [];
                    if (!value && !values[0]) {
                        target.innerHTML = '<span class="diff-empty">No data</span>';
                        return;
                    }
                    target.innerHTML = diffToHtml(diffParts) || '<span class="diff-empty">No data</span>';
                });

                setSectionCollapsed(section.key, Boolean(section.allSame));
            });
        }

        function setupSectionToggles() {
            document.querySelectorAll('.section-toggle').forEach((button) => {
                const sectionKey = button.dataset.section;
                if (!sectionKey) return;
                button.addEventListener('click', () => {
                    const isCollapsed = collapsedSections.get(sectionKey);
                    setSectionCollapsed(sectionKey, !isCollapsed);
                });
            });
        }

        function renderTimeline() {
            const rows = Array.from(document.querySelectorAll('.timeline-row'));
            if (!rows.length) return;

            const durations = rows.map((row) => Number(row.dataset.duration || 0));
            const maxDuration = Math.max(...durations, 1);

            rows.forEach((row, index) => {
                const value = durations[index];
                const percent = Math.round((value / maxDuration) * 100);
                const clamped = Math.min(100, Math.max(4, percent));
                row.style.setProperty('--duration', `${clamped}%`);
            });
        }

        function buildMarkdown() {
            const lines = [];
            const baselineLabel = baselineIndex + 1;
            lines.push('# Log comparison');
            lines.push('');
            lines.push('## Summary');
            lines.push('| Log | Method | Status | Duration | Timestamp | URL |');
            lines.push('| --- | --- | --- | --- | --- | --- |');
            logs.forEach((log, index) => {
                const method = log?.request?.method || '';
                const status = log?.response?.status ?? '';
                const duration = `${log?.duration_ms || 0}ms`;
                const timestamp = log?.timestamp ? new Date(log.timestamp).toLocaleString() : '';
                const url = (log?.request?.url || '').replace(/\|/g, '\\|');
                const label = index === baselineIndex
                    ? `${index + 1} (baseline)`
                    : `${index + 1}`;
                lines.push(`| ${label} | ${method} | ${status} | ${duration} | ${timestamp} | ${url} |`);
            });
            lines.push('');

            compareSections.forEach((section) => {
                lines.push(`## ${section.label || section.title || ''}`);
                lines.push('');
                const values = sectionValues.get(section.key) || [];
                lines.push(`### Log ${baselineLabel} (baseline)`);
                lines.push('```json');
                lines.push(values[baselineIndex] || '');
                lines.push('```');
                lines.push('');

                for (let i = 0; i < logs.length; i += 1) {
                    if (i === baselineIndex) {
                        continue;
                    }
                    lines.push(`### Log ${i + 1} diff vs Log ${baselineLabel}`);
                    lines.push('```diff');
                    const diffParts = diffCache.get(section.key)?.[i] || [];
                    const diffText = diffToMarkdown(diffParts);
                    lines.push(diffText || '');
                    lines.push('```');
                    lines.push('');
                }
            });

            return lines.join('\n');
        }

        function setupBaselinePicker() {
            const select = document.getElementById('baseline-select');
            if (!select) return;
            select.value = String(baselineIndex + 1);
            select.addEventListener('change', () => {
                const params = new URLSearchParams(window.location.search);
                params.set('baseline', select.value);
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            });
        }

        function setupMarkdownCopy() {
            const button = document.getElementById('copy-markdown');
            if (!button) return;

            button.addEventListener('click', () => {
                const markdown = buildMarkdown();
                if (!markdown) return;
                navigator.clipboard.writeText(markdown).then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.style.background = 'rgba(47, 138, 74, 0.15)';
                    button.style.color = '#1f6a36';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                        button.style.color = '';
                    }, 2000);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderDiffs();
            setupSectionToggles();
            renderTimeline();
            setupBaselinePicker();
            setupMarkdownCopy();
        });
    </script>
</body>
</html>
