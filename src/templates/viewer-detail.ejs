<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Debugger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        :root {
            color-scheme: light;
            --bg: #f7f8fa;
            --bg-strong: #eef1f4;
            --panel: #ffffff;
            --panel-alt: #f6f8fa;
            --ink: #1d1f23;
            --muted: #5d6670;
            --accent: #10a37f;
            --accent-strong: #0f8a6b;
            --stroke: #e2e6ea;
            --success: #1a7f4a;
            --danger: #b3261e;
            --code-bg: #f3f5f7;
            --code-ink: #1f2933;
            --code-border: #e1e5ea;
            --shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 10px 26px rgba(15, 23, 42, 0.08);
            --focus: rgba(16, 163, 127, 0.22);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "IBM Plex Sans", "Helvetica Neue", sans-serif;
            background:
                radial-gradient(1200px 520px at 12% -10%, rgba(16, 163, 127, 0.12), transparent 60%),
                radial-gradient(1000px 500px at 95% -20%, rgba(15, 23, 42, 0.08), transparent 60%),
                linear-gradient(180deg, var(--bg) 0%, #f1f3f6 100%);
            color: var(--ink);
        }

        .page {
            min-height: 100vh;
            padding: 32px 18px 64px;
        }

        .shell {
            max-width: 1120px;
            margin: 0 auto;
            display: grid;
            gap: 24px;
        }

        .back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-strong);
            text-decoration: none;
            font-weight: 600;
        }

        .back::before {
            content: "\2190";
        }

        .header {
            display: grid;
            gap: 16px;
            padding: 26px;
            border-radius: 24px;
            border: 1px solid var(--stroke);
            background: var(--panel);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            animation: none;
        }

        .header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(16, 163, 127, 0.12), transparent 60%);
            pointer-events: none;
        }

        .title {
            font-family: "Sora", "Helvetica Neue", sans-serif;
            font-size: clamp(1.5rem, 2vw + 1rem, 2.2rem);
            margin: 0 0 8px;
            position: relative;
            z-index: 1;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .subtitle {
            margin: 0;
            color: var(--muted);
            position: relative;
            z-index: 1;
        }

        .summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
            position: relative;
            z-index: 1;
            font-variant-numeric: tabular-nums;
        }

        .metric {
            padding: 12px 14px;
            border-radius: 16px;
            border: 1px solid var(--stroke);
            background: var(--panel-alt);
        }

        .metric span {
            display: block;
        }

        .metric .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .metric .value {
            font-size: 1rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .value.ok { color: var(--success); }
        .value.bad { color: var(--danger); }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            background: var(--bg-strong);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .pill-group {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .pill.shape {
            background: rgba(16, 163, 127, 0.12);
            color: var(--accent-strong);
        }

        .pill.get { background: rgba(26, 127, 74, 0.12); color: #13633b; }
        .pill.post { background: rgba(22, 98, 166, 0.12); color: #1c4a7d; }
        .pill.put { background: rgba(200, 120, 28, 0.12); color: #7a4d16; }
        .pill.delete { background: rgba(179, 38, 30, 0.12); color: #7e1f18; }
        .pill.patch { background: rgba(96, 74, 155, 0.12); color: #4a3a8a; }

        .url {
            font-family: "IBM Plex Mono", monospace;
            font-size: 0.9rem;
            color: var(--ink);
            font-weight: 600;
            word-break: break-all;
            margin-top: 6px;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            padding: 18px 22px;
            border-radius: 20px;
            border: 1px solid var(--stroke);
            background: var(--panel);
        }

        .btn {
            border: none;
            border-radius: 14px;
            padding: 10px 14px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease;
            box-shadow: 0 10px 24px rgba(16, 163, 127, 0.28);
            min-height: 40px;
        }

        .btn.secondary {
            background: #fff;
            color: var(--ink);
            border: 1px solid var(--stroke);
            box-shadow: none;
        }

        .btn.danger {
            background: var(--danger);
            box-shadow: 0 10px 24px rgba(179, 38, 30, 0.28);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.18);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border-radius: 16px;
            border: 1px solid var(--stroke);
            background: rgba(255, 255, 255, 0.92);
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 16px;
            z-index: 4;
            backdrop-filter: blur(6px);
        }

        .tab-button {
            border: 1px solid transparent;
            border-radius: 14px;
            padding: 8px 16px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: transform 160ms ease, box-shadow 160ms ease, color 160ms ease;
            min-height: 36px;
            position: relative;
        }

        .tab-button::after {
            content: "";
            position: absolute;
            left: 12px;
            right: 12px;
            bottom: 6px;
            height: 2px;
            border-radius: 999px;
            background: transparent;
            transition: background 160ms ease;
        }

        .tab-button:hover {
            color: var(--ink);
            background: rgba(16, 163, 127, 0.08);
            border-color: rgba(16, 163, 127, 0.18);
        }

        .tab-button.is-active {
            background: #fff;
            color: var(--ink);
            border-color: rgba(16, 163, 127, 0.35);
            box-shadow: var(--shadow-soft);
        }

        .tab-button.is-active::after {
            background: var(--accent);
        }

        .tab-panel {
            display: none;
            animation: none;
        }

        .tab-panel.is-active {
            display: block;
        }

        .panel {
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--stroke);
            background: var(--panel);
            display: grid;
            gap: 12px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            min-height: 36px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--stroke);
            position: relative;
        }

        .panel-header::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 42px;
            height: 2px;
            border-radius: 999px;
            background: var(--accent);
        }

        .panel h3 {
            margin: 0;
            font-size: 0.98rem;
            font-weight: 700;
        }

        .preview-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        .message-list {
            display: grid;
            gap: 16px;
        }

        .message-card {
            border-radius: 18px;
            border: 1px solid var(--stroke);
            background: linear-gradient(135deg, var(--role-wash, rgba(15, 23, 42, 0.02)), #fff 60%);
            padding: 18px;
            display: grid;
            gap: 12px;
            position: relative;
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
        }

        .message-card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 14px;
            bottom: 14px;
            width: 4px;
            border-radius: 999px;
            background: var(--role-accent, var(--stroke));
        }

        .message-card.role-system {
            --role-accent: rgba(179, 38, 30, 0.6);
            --role-wash: rgba(179, 38, 30, 0.08);
        }

        .message-card.role-user {
            --role-accent: rgba(22, 98, 166, 0.6);
            --role-wash: rgba(22, 98, 166, 0.08);
        }

        .message-card.role-assistant {
            --role-accent: rgba(26, 127, 74, 0.6);
            --role-wash: rgba(26, 127, 74, 0.08);
        }

        .message-card.role-tool {
            --role-accent: rgba(96, 74, 155, 0.6);
            --role-wash: rgba(96, 74, 155, 0.08);
        }

        .message-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            font-variant-numeric: tabular-nums;
        }

        .message-role {
            font-weight: 700;
            color: var(--role-accent, var(--accent-strong));
            background: var(--role-wash, rgba(16, 163, 127, 0.12));
            padding: 4px 8px;
            border-radius: 999px;
        }

        .message-name {
            font-weight: 600;
            color: var(--muted);
        }

        .message-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--muted);
        }

        .message-tag {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(16, 163, 127, 0.12);
            color: var(--accent-strong);
            font-weight: 600;
        }

        .message-parts {
            display: grid;
            gap: 10px;
        }

        .message-text {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
            color: var(--ink);
        }

        .message-image {
            max-width: 100%;
            border-radius: 12px;
            border: 1px solid var(--stroke);
            background: #fff;
        }

        .message-tool,
        .message-json,
        .message-reasoning,
        .message-refusal {
            background: rgba(15, 23, 42, 0.04);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .message-tool pre,
        .message-json pre,
        .message-reasoning pre {
            margin: 8px 0 0;
            background: transparent;
            color: var(--ink);
            padding: 0;
            font-size: 0.8rem;
            line-height: 1.55;
            white-space: pre-wrap;
        }

        .message-tool code,
        .message-json code,
        .message-reasoning code {
            font-family: "IBM Plex Mono", monospace;
        }

        .message-refusal {
            color: var(--danger);
            font-weight: 600;
        }

        .tool-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            font-weight: 600;
        }

        .message-file {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-strong);
            font-weight: 600;
            text-decoration: none;
        }

        .preview-block {
            max-height: calc(12 * 1.55em);
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .preview-block::before {
            content: "Click to expand";
            position: absolute;
            right: 12px;
            bottom: 10px;
            font-size: 0.65rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(29, 31, 35, 0.6);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 999px;
            z-index: 1;
            opacity: 0.7;
            transition: opacity 160ms ease;
        }

        .preview-block::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 32px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.92) 100%);
            pointer-events: none;
        }

        .preview-block:hover::before,
        .code-block:hover::before {
            opacity: 1;
        }

        .preview-block.expanded {
            max-height: none;
        }

        .preview-block.expanded::before,
        .preview-block.expanded::after {
            display: none;
        }

        details.message-reasoning > summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--accent-strong);
        }

        .spec-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        .spec-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
            margin: 0 0 8px;
        }

        .spec-list {
            margin: 0;
            display: grid;
            gap: 10px;
        }

        .spec-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px dashed var(--stroke);
            background: #fff;
        }

        .spec-row dt {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }

        .spec-row dd {
            margin: 0;
            font-weight: 600;
            word-break: break-word;
            font-variant-numeric: tabular-nums;
        }

        .preview-errors {
            margin-top: 12px;
            display: grid;
            gap: 6px;
            color: var(--danger);
            font-size: 0.85rem;
        }

        .icon-button {
            border: 1px solid var(--stroke);
            background: #fff;
            color: var(--accent-strong);
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease;
        }

        .icon-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(16, 163, 127, 0.2);
        }

        .icon-button.is-copied {
            background: rgba(26, 127, 74, 0.12);
            color: #13633b;
            border-color: rgba(26, 127, 74, 0.3);
        }

        .btn:focus-visible,
        .tab-button:focus-visible,
        .icon-button:focus-visible,
        .back:focus-visible,
        .message-file:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus);
        }

        .icon-button svg {
            width: 16px;
            height: 16px;
        }

        pre {
            margin: 0;
            background: var(--code-bg);
            color: var(--code-ink);
            padding: 18px;
            border-radius: 16px;
            border: 1px solid var(--code-border);
            overflow-x: auto;
            font-size: 0.84rem;
            line-height: 1.65;
            tab-size: 2;
        }

        pre code.hljs {
            background: transparent;
        }

        .code-block {
            max-height: calc(50 * 1.5em);
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .code-block::before {
            content: "Click to expand";
            position: absolute;
            right: 16px;
            bottom: 12px;
            font-size: 0.65rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(31, 41, 51, 0.7);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 999px;
            z-index: 1;
            opacity: 0.7;
            transition: opacity 160ms ease;
        }

        .code-block::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 36px;
            background: linear-gradient(180deg, rgba(243, 245, 247, 0) 0%, rgba(243, 245, 247, 0.92) 100%);
            pointer-events: none;
        }

        .code-block.expanded {
            max-height: none;
        }

        .code-block.expanded::before {
            display: none;
        }

        .code-block.expanded::after {
            display: none;
        }

        .muted {
            color: var(--muted);
            font-size: 0.85rem;
        }

        @media (max-width: 720px) {
            .header {
                padding: 20px;
            }

            .actions {
                padding: 16px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <% const providerName = log.provider || 'unknown'; %>
    <% const appName = log.request.headers['x-title'] || log.request.headers['http-referer'] || log.request.headers['X-Title'] || log.request.headers['HTTP-Referer'] || log.request.headers['referer'] || log.request.headers['Referer']; %>
    <% const detailAltText = `Request log\\n${providerName}${appName ? ` - ${appName}` : ''}\\n\\n${log.request.url}`; %>
    <% const previewData = preview || {}; %>
    <% const previewRequest = previewData.request || { messages: [] }; %>
    <% const previewResponse = previewData.response || { messages: [] }; %>
    <% const previewSpec = previewData.spec || { request: [], response: [] }; %>
    <% function formatPreviewValue(value) { %>
        <% try { %>
            <% if (typeof value === 'string') return value; %>
            <% if (value === null || value === undefined) return ''; %>
            <% return JSON.stringify(value, null, 2); %>
        <% } catch (error) { %>
            <% return String(value); %>
        <% } %>
    <% } %>
    <div class="page">
        <div class="shell">
            <a class="back" href="<%= backLink %>">Back to viewer</a>

            <section class="header" aria-label="<%= detailAltText %>" title="<%= detailAltText %>">
                <div>
                    <div class="pill-group">
                        <span class="pill <%= log.request.method.toLowerCase() %>"><%= log.request.method %></span>
                        <span class="pill shape"><%= previewData.shapeLabel || 'Other' %></span>
                    </div>
                    <h1 class="title"><%= log.request.url %></h1>
                    <p class="subtitle"><%= providerName %> <%= appName ? `- ${appName}` : '' %></p>
                </div>
                <div class="summary">
                    <div class="metric">
                        <span class="label">Status</span>
                        <span class="value <%= log.response.status < 400 ? 'ok' : 'bad' %>"><%= log.response.status %></span>
                    </div>
                    <div class="metric">
                        <span class="label">Duration</span>
                        <span class="value"><%= log.duration_ms || 0 %>ms</span>
                    </div>
                    <div class="metric">
                        <span class="label">Timestamp</span>
                        <span class="value"><%= new Date(log.timestamp).toLocaleString() %></span>
                    </div>
                    <div class="metric">
                        <span class="label">Streaming</span>
                        <span class="value"><%= log.response.is_streaming ? 'Yes' : 'No' %></span>
                    </div>
                </div>
            </section>

            <section class="actions">
                <button class="btn secondary" onclick="copyPython(this)">Copy Python</button>
                <button class="btn danger" id="delete-btn" onclick="deleteEntry(this)">Delete</button>
            </section>

            <section class="tabs" role="tablist">
                <button class="tab-button is-active" type="button" data-tab="raw">Raw</button>
                <button class="tab-button" type="button" data-tab="preview">Preview</button>
            </section>

            <section class="tab-panel" data-tab="preview">
                <% if (previewData.errors && previewData.errors.length) { %>
                    <div class="preview-errors">
                        <% previewData.errors.forEach((error) => { %>
                            <div><%= error %></div>
                        <% }) %>
                    </div>
                <% } %>

                <div class="preview-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Request messages</h3>
                            <span class="muted"><%= previewRequest.messages.length %> item(s)</span>
                        </div>
                        <% if (!previewRequest.messages.length) { %>
                            <p class="muted">No request messages detected for this API shape.</p>
                        <% } else { %>
                            <div class="message-list">
                                <% previewRequest.messages.forEach((message) => { %>
                                    <div class="message-card role-<%= message.role %>">
                                        <div class="message-meta">
                                            <span class="message-role"><%= message.role %></span>
                                            <% if (message.name) { %>
                                                <span class="message-name"><%= message.name %></span>
                                            <% } %>
                                        </div>
                                        <% const requestMeta = message.metadata ? Object.entries(message.metadata) : []; %>
                                        <% if (requestMeta.length) { %>
                                            <div class="message-tags">
                                                <% requestMeta.forEach(([key, value]) => { %>
                                                    <span class="message-tag"><%= key %>: <%= value %></span>
                                                <% }) %>
                                            </div>
                                        <% } %>
                                        <div class="message-parts">
                                            <% (message.parts || []).forEach((part) => { %>
                                                <% const partType = part && part.type ? part.type : 'text'; %>
                                                <% if (partType === 'text') { %>
                                                    <div class="preview-block">
                                                        <p class="message-text"><%= part.text %></p>
                                                    </div>
                                                <% } else if (partType === 'image') { %>
                                                    <% if (part.url) { %>
                                                        <img class="message-image" src="<%= part.url %>" alt="preview image" loading="lazy">
                                                    <% } %>
                                                <% } else if (partType === 'reasoning') { %>
                                                    <details class="message-reasoning">
                                                        <summary>Reasoning</summary>
                                                        <div class="preview-block">
                                                            <pre><code><%= part.text %></code></pre>
                                                        </div>
                                                    </details>
                                                <% } else if (partType === 'tool_call') { %>
                                                    <div class="message-tool preview-block">
                                                        <div class="tool-label">Tool call: <%= part.name %></div>
                                                        <% if (part.arguments) { %>
                                                            <pre><code><%= formatPreviewValue(part.arguments) %></code></pre>
                                                        <% } %>
                                                    </div>
                                                <% } else if (partType === 'refusal') { %>
                                                    <div class="message-refusal"><%= part.text %></div>
                                                <% } else if (partType === 'file') { %>
                                                    <% if (part.url) { %>
                                                        <a class="message-file" href="<%= part.url %>" target="_blank" rel="noreferrer">File attachment</a>
                                                    <% } %>
                                                <% } else if (partType === 'json') { %>
                                                    <div class="message-json preview-block">
                                                        <pre><code><%= formatPreviewValue(part.json) %></code></pre>
                                                    </div>
                                                <% } %>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        <% } %>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3>Response messages</h3>
                            <span class="muted"><%= previewResponse.messages.length %> item(s)</span>
                        </div>
                        <% if (!previewResponse.messages.length) { %>
                            <p class="muted">No response messages detected for this API shape.</p>
                        <% } else { %>
                            <div class="message-list">
                                <% previewResponse.messages.forEach((message) => { %>
                                    <div class="message-card role-<%= message.role %>">
                                        <div class="message-meta">
                                            <span class="message-role"><%= message.role %></span>
                                            <% if (message.name) { %>
                                                <span class="message-name"><%= message.name %></span>
                                            <% } %>
                                        </div>
                                        <% const responseMeta = message.metadata ? Object.entries(message.metadata) : []; %>
                                        <% if (responseMeta.length) { %>
                                            <div class="message-tags">
                                                <% responseMeta.forEach(([key, value]) => { %>
                                                    <span class="message-tag"><%= key %>: <%= value %></span>
                                                <% }) %>
                                            </div>
                                        <% } %>
                                        <div class="message-parts">
                                            <% (message.parts || []).forEach((part) => { %>
                                                <% const partType = part && part.type ? part.type : 'text'; %>
                                                <% if (partType === 'text') { %>
                                                    <div class="preview-block">
                                                        <p class="message-text"><%= part.text %></p>
                                                    </div>
                                                <% } else if (partType === 'image') { %>
                                                    <% if (part.url) { %>
                                                        <img class="message-image" src="<%= part.url %>" alt="preview image" loading="lazy">
                                                    <% } %>
                                                <% } else if (partType === 'reasoning') { %>
                                                    <details class="message-reasoning">
                                                        <summary>Reasoning</summary>
                                                        <div class="preview-block">
                                                            <pre><code><%= part.text %></code></pre>
                                                        </div>
                                                    </details>
                                                <% } else if (partType === 'tool_call') { %>
                                                    <div class="message-tool preview-block">
                                                        <div class="tool-label">Tool call: <%= part.name %></div>
                                                        <% if (part.arguments) { %>
                                                            <pre><code><%= formatPreviewValue(part.arguments) %></code></pre>
                                                        <% } %>
                                                    </div>
                                                <% } else if (partType === 'refusal') { %>
                                                    <div class="message-refusal"><%= part.text %></div>
                                                <% } else if (partType === 'file') { %>
                                                    <% if (part.url) { %>
                                                        <a class="message-file" href="<%= part.url %>" target="_blank" rel="noreferrer">File attachment</a>
                                                    <% } %>
                                                <% } else if (partType === 'json') { %>
                                                    <div class="message-json preview-block">
                                                        <pre><code><%= formatPreviewValue(part.json) %></code></pre>
                                                    </div>
                                                <% } %>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        <% } %>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3>Spec</h3>
                            <span class="muted">Request + response</span>
                        </div>
                        <div class="spec-grid">
                            <div>
                                <p class="spec-title">Request</p>
                                <% if (!previewSpec.request.length) { %>
                                    <p class="muted">No spec fields detected.</p>
                                <% } else { %>
                                    <dl class="spec-list">
                                        <% previewSpec.request.forEach((item) => { %>
                                            <div class="spec-row">
                                                <dt><%= item.label %></dt>
                                                <dd><%= item.value %></dd>
                                            </div>
                                        <% }) %>
                                    </dl>
                                <% } %>
                            </div>
                            <div>
                                <p class="spec-title">Response</p>
                                <% if (!previewSpec.response.length) { %>
                                    <p class="muted">No spec fields detected.</p>
                                <% } else { %>
                                    <dl class="spec-list">
                                        <% previewSpec.response.forEach((item) => { %>
                                            <div class="spec-row">
                                                <dt><%= item.label %></dt>
                                                <dd><%= item.value %></dd>
                                            </div>
                                        <% }) %>
                                    </dl>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="tab-panel is-active" data-tab="raw">
                <section class="grid">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Request headers</h3>
                        <button class="icon-button" onclick="copyRequestHeaders(this)" aria-label="Copy request headers" title="Copy request headers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <pre class="code-block" aria-label="Request headers (click to expand)" title="Click to expand/collapse"><code id="request-headers" class="language-json"></code></pre>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <h3>Response headers</h3>
                        <button class="icon-button" onclick="copyResponseHeaders(this)" aria-label="Copy response headers" title="Copy response headers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <pre class="code-block" aria-label="Response headers (click to expand)" title="Click to expand/collapse"><code id="response-headers" class="language-json"></code></pre>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <h3>Request body</h3>
                        <button class="icon-button" onclick="copyRequestBody(this)" aria-label="Copy request body" title="Copy request body">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <pre class="code-block" aria-label="Request body (click to expand)" title="Click to expand/collapse"><code id="request-body" class="language-json"></code></pre>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <h3>Response body</h3>
                        <button class="icon-button" onclick="copyResponseBody(this)" aria-label="Copy response body" title="Copy response body">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <pre class="code-block" aria-label="Response body (click to expand)" title="Click to expand/collapse"><code id="response-body" class="language-json"></code></pre>
                </div>
                </section>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script>
        window.LOG_ENTRY = <%- JSON.stringify(log).replace(/</g, '\\u003c') %>;

        function formatJson(data) {
            if (typeof data === 'object' && data !== null) {
                return JSON.stringify(data, null, 2);
            }
            return data || '';
        }

        function setCode(id, value) {
            const element = document.getElementById(id);
            if (!element) return;
            element.textContent = value;
            hljs.highlightElement(element);
        }

        function renderLog() {
            const log = window.LOG_ENTRY || {};
            setCode('request-headers', formatJson(log?.request?.headers));
            setCode('request-body', formatJson(log?.request?.body));
            setCode('response-headers', formatJson(log?.response?.headers));
            setCode('response-body', formatJson(log?.response?.body));

        }

        function setupTabs() {
            const buttons = Array.from(document.querySelectorAll('.tab-button'));
            const panels = Array.from(document.querySelectorAll('.tab-panel'));
            if (!buttons.length || !panels.length) return;

            const activate = (tabName) => {
                buttons.forEach((button) => {
                    button.classList.toggle('is-active', button.dataset.tab === tabName);
                });
                panels.forEach((panel) => {
                    panel.classList.toggle('is-active', panel.dataset.tab === tabName);
                });
            };

            const initial = buttons.find((button) => button.classList.contains('is-active'));
            activate(initial ? initial.dataset.tab : buttons[0].dataset.tab);

            buttons.forEach((button) => {
                button.addEventListener('click', () => activate(button.dataset.tab));
            });
        }

        function indentMultiline(text, spaces) {
            const pad = ' '.repeat(spaces);
            return text
                .split('\n')
                .map((line, index) => (index === 0 ? line : pad + line))
                .join('\n');
        }

        function toPythonLiteral(value, depth = 0) {
            const indentUnit = '    ';
            const currentIndent = indentUnit.repeat(depth);
            const nextIndent = indentUnit.repeat(depth + 1);

            if (
                value &&
                typeof value === 'object' &&
                !Array.isArray(value) &&
                Object.prototype.hasOwnProperty.call(value, '__python_raw__')
            ) {
                return value.__python_raw__;
            }
            if (value === null || typeof value === 'undefined') {
                return 'None';
            }
            if (typeof value === 'string') {
                const escaped = value
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/\r/g, '\\r')
                    .replace(/\n/g, '\\n')
                    .replace(/\t/g, '\\t');
                return `'${escaped}'`;
            }
            if (typeof value === 'number') {
                return Number.isFinite(value) ? String(value) : 'None';
            }
            if (typeof value === 'boolean') {
                return value ? 'True' : 'False';
            }
            if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '[]';
                }
                const items = value
                    .map((item) => `${nextIndent}${toPythonLiteral(item, depth + 1)}`)
                    .join(',\n');
                return `[\n${items}\n${currentIndent}]`;
            }
            if (typeof value === 'object') {
                const entries = Object.entries(value);
                if (entries.length === 0) {
                    return '{}';
                }
                const props = entries
                    .map(([key, val]) => {
                        const escapedKey = String(key)
                            .replace(/\\/g, '\\\\')
                            .replace(/'/g, "\\'");
                        return `${nextIndent}'${escapedKey}': ${toPythonLiteral(val, depth + 1)}`;
                    })
                    .join(',\n');
                return `{\n${props}\n${currentIndent}}`;
            }
            return 'None';
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                if (btn.classList.contains('icon-button')) {
                    const originalTitle = btn.getAttribute('title') || '';
                    btn.dataset.originalTitle = originalTitle;
                    btn.setAttribute('title', 'Copied!');
                    btn.classList.add('is-copied');
                    setTimeout(() => {
                        btn.setAttribute('title', btn.dataset.originalTitle || '');
                        btn.classList.remove('is-copied');
                        delete btn.dataset.originalTitle;
                    }, 2000);
                } else {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = 'rgba(47, 138, 74, 0.15)';
                    btn.style.color = '#1f6a36';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                }
            });
        }

        function copyPython(btn) {
            const log = window.LOG_ENTRY || {};
            const method = (log?.request?.method || 'get').toLowerCase();
            const url = log?.request?.url || '';
            const headers = { ...(log?.request?.headers || {}) };
            let needsEnv = false;
            const authKey = Object.keys(headers).find((key) => key.toLowerCase() === 'authorization');
            if (authKey && typeof headers[authKey] === 'string') {
                const authValue = headers[authKey];
                if (authValue === 'api_key_provided') {
                    headers[authKey] = { __python_raw__: "f'Bearer {api_key}'" };
                    needsEnv = true;
                } else if (authValue.includes('api_key_provided') && authValue.startsWith('Bearer ')) {
                    headers[authKey] = {
                        __python_raw__: "f'Bearer {api_key}'"
                    };
                    needsEnv = true;
                }
            }
            const headersLiteral = indentMultiline(toPythonLiteral(headers), 4);
            const body = log?.request?.body;
            const bodyLiteral = body !== undefined && body !== null
                ? indentMultiline(toPythonLiteral(body), 4)
                : null;

            const lines = [
                needsEnv ? 'import os' : null,
                'import json',
                'import requests',
                '',
                needsEnv ? 'api_key = os.environ.get(\'API_KEY\')' : null,
                needsEnv ? 'if not api_key:' : null,
                needsEnv ? '    raise SystemExit(\'Set API_KEY environment variable before running.\')' : null,
                needsEnv ? '' : null,
                `response = requests.${method}(`,
                `    '${url}',`,
                `    headers=${headersLiteral},`,
                bodyLiteral ? `    json=${bodyLiteral},` : null,
                ')',
                '',
                'print(f\'Status: {response.status_code} {response.reason}\')',
                'print(\'Response headers:\')',
                'for key, value in response.headers.items():',
                '    print(f\'  {key}: {value}\')',
                '',
                'try:',
                '    data = response.json()',
                '    print(\'Response JSON:\')',
                '    print(json.dumps(data, indent=2))',
                'except ValueError:',
                '    print(\'Response text:\')',
                '    print(response.text)',
            ].filter((line) => line !== null);

            const code = lines.join('\n');
            copyToClipboard(code, btn);
        }

        function copyResponseHeaders(btn) {
            const headers = window.LOG_ENTRY?.response?.headers;
            copyToClipboard(formatJson(headers), btn);
        }

        function copyRequestHeaders(btn) {
            const headers = window.LOG_ENTRY?.request?.headers;
            copyToClipboard(formatJson(headers), btn);
        }

        function copyResponseBody(btn) {
            const body = window.LOG_ENTRY?.response?.body;
            copyToClipboard(formatJson(body), btn);
        }

        function copyRequestBody(btn) {
            const body = window.LOG_ENTRY?.request?.body;
            copyToClipboard(formatJson(body), btn);
        }

        async function deleteEntry(btn) {
            if (!confirm('Are you sure you want to delete this log entry? This action cannot be undone.')) {
                return;
            }

            const provider = '<%= log._viewer_provider %>';
            const filename = '<%= log._viewer_file %>';
            const deleteUrl = `/__viewer__/${encodeURIComponent(provider)}/${encodeURIComponent(filename)}`;

            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const response = await fetch(deleteUrl, { method: 'DELETE' });
                if (response.ok) {
                    window.location.href = '<%= backLink %>';
                } else {
                    const data = await response.json().catch(() => ({}));
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            } catch (error) {
                alert('Failed to delete: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Delete';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderLog();
            setupTabs();
        });
        document.addEventListener('click', (event) => {
            const block = event.target.closest('.code-block, .preview-block');
            if (!block) return;
            block.classList.toggle('expanded');
        });
    </script>
</body>
</html>
